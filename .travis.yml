language: elixir
sudo: required
cache:
  directories:
    - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=place_your_account_name_here
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker and GitHub credentials
    - secure: "QH42Qa66bA84xONdus+3IRF0cz8EWlImTG5OTcYeqANTz6vnpb/2Yl/hW78bjHMxSzUcEGym2KNucS5SwR3YFx+Jik3brxUFxV5y27SYo66oE/2rs28uE4qo0AvJ1VvXpPFn/FFYKF6gKkfOZSOGo07kr0akHER7ODx5YpGD+S+bZAmaly+rCzaqIvI4mzJAoFlkgwVS5jNEUViQgHS9zeB3jKuJ2RBKu5/Xp5npi3ZsPOFui8M1rlBI704kKPpOgXL12p/1fH0gmkOBDpBbSGm/RaqrqPiGUqsPcWkqhRdrAgudHvk8tSmr1c5xYQm6RiigSvjspwZ1IhjfELTarMc4b+N2HlWf+ncMhGz3FYeWjOKjVF6xNrw127+Ms8+hp/TW2A2j9z4NoXe0YUnBKDQusEvflBB6K+S9TAtOV+ERLtgIBZhbCX/f+nI3tr5ZFU81KmRvh9b87GBayANpzz134Hccth8inTXi+LTG2I3CTCIjD+JaQ8MuFpnVt5WH7X4W/+ExuJsZM1bGT4ztdIlO21gmqklpj3k+BuDVIliIliQ3mwizKsyZjECzZpZoKqk09SzDOZpHoYA5Y3CleC01FbSNVXZOel3TLJsvQ3Hn2bhyIW9FrIVoUxqllxhlO6DxckvMbE1CilxgAS7F8v/tsifRXXMC/qltZva/Wtg="
    - secure: "H7I8A1CXE/c4bczUEuJJ3V0pAgwbbZXCggO/YOdN/YbrhuFP0bK8/O9uKwflezdzYJxAmBCQHIo9dnEI+J/1+ZALOUGgNts1L0nBWtfZusdh7p8ll+kgRbiYZBdFpcBh/fc29iBni61heE0JL6aJrm8cRs1O+eeTEusEoBRPpVNK7mX56Xu6awwtRcU+F+sj+5bSehTtAXrFzi5mt+hWbK5+shkZb4KUmBIR2YeX5vLp+eUXY5AUmpDTWrQmohLmhRxvNpEsgyWqfMZWX7pfp1/8UWDHKGBYNK5MF7ZNZEjVnQQTaVzJ2TS4sxwrk8JETLnF8/hqpP32lWZjNZ2HOFWd8BiFNwaqjsjSIEtBDcASzijUto9wuEGbnCTNDHK662/OEcXEenh0HEbg4eGK4yRH6uqFAlN9rGBGHZQhBALVYT7fGKr0rP5XQgOt3kFc/FqTaOSmpx9eimCy+JgHLmsUdw4bOIYEjek3wtrD9NyYD44GyAry0/EOzeGxud493HWidC4hH36hX6QT7jdTImM8MlNdy/hgh23w83XQxd9wBbBvdKERlK27U3NzGfvmrhsdEmKxpvIZEyeO396purSPIEWYIV60sbG9Jvhqw4ndgU3uUkqMMBcoVGWe4UZ5NzN7CPH8GWBuDKLW0eaLacWkIszASGoWpvtndHqtP+M="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  # Uncomment this if you want to increment patch version on each Travis build.
  # - ./bin/ci/version-increment.sh
  # Install dependencies
  - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  # Add --pro if you using private repo.
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - MIX_ENV=dev mix ecto.setup
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs otp_verification_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/acceptance"
after_failure:
  - docker logs otp_verification_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
